<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centelha - Assistente Virtual Inteligente</title>
    <!-- üõë CORRE√á√ÉO CR√çTICA DE ESTABILIDADE: Content Security Policy (CSP) ajustada -->
    <!-- Adiciona wss (WebSocket) e dom√≠nios do Firebase para evitar erros de Refused to connect -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self'; 
        script-src 'self' https://cdn.tailwindcss.com https://www.gstatic.com https://unpkg.com 'unsafe-inline' 'unsafe-eval'; 
        style-src 'self' https://cdn.tailwindcss.com 'unsafe-inline'; 
        font-src 'self' https://fonts.gstatic.com;
        img-src 'self' data: https:;
        connect-src 'self' https://* wss://* api.googleapis.com;
        frame-src 'self' https://*.google.com;
    ">

    <!-- Tailwind CSS CDN para visualiza√ß√£o r√°pida (Para produ√ß√£o, remover e usar build tool) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos base para a interface */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .chat-container { max-width: 768px; height: 90vh; }
        .chat-messages { overflow-y: auto; scroll-behavior: smooth; }
        .message-bubble { 
            max-width: 80%; 
            padding: 10px 14px; 
            border-radius: 18px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        .user-bubble { background-color: #2563eb; color: white; border-bottom-right-radius: 4px; }
        .assistant-bubble { background-color: #ffffff; color: #1f2937; border-bottom-left-radius: 4px; }
        .chat-action-button { 
            display: inline-block; 
            padding: 6px 12px; 
            border-radius: 9999px; /* Full rounded */
            font-size: 0.875rem; 
            font-weight: 600;
            margin-top: 8px;
            margin-right: 8px;
            transition: transform 0.1s;
        }
        .chat-action-button:hover { transform: scale(1.05); }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
    <div id="chat-container" class="chat-container w-full bg-white rounded-xl shadow-2xl flex flex-col">
        <!-- Header -->
        <header class="p-4 border-b border-gray-200 bg-blue-600 rounded-t-xl text-white flex justify-between items-center">
            <h1 class="text-xl font-bold">Centelha AI</h1>
            <span id="user-id-display" class="text-sm font-mono bg-blue-700 py-1 px-3 rounded-full shadow-md">ID: Carregando...</span>
        </header>

        <!-- Messages Area -->
        <div id="chat-messages" class="chat-messages p-4 flex-grow space-y-3">
            <!-- Messages will be rendered here -->
            <div class="flex justify-center">
                <div class="message-bubble assistant-bubble text-center text-gray-500">
                    Ol√°! Eu sou a Centelha, seu assistente virtual. Como posso te ajudar hoje?
                </div>
            </div>
        </div>

        <!-- Quick Replies Area -->
        <div id="quick-replies" class="p-4 border-t border-gray-200 flex flex-wrap gap-2 min-h-[40px] bg-gray-50">
            <!-- Quick replies will appear here -->
        </div>

        <!-- Input Area -->
        <div class="p-4 border-t border-gray-200 flex space-x-3 bg-gray-100 rounded-b-xl">
            <input type="text" id="user-input" placeholder="Digite sua mensagem..." class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150" autocomplete="off">
            <button id="send-button" class="bg-blue-600 text-white p-3 rounded-lg shadow-md hover:bg-blue-700 disabled:opacity-50 transition duration-150 flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 transform rotate-90" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                </svg>
            </button>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js";

        // Vari√°veis globais de ambiente (MANDAT√ìRIAS)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        // O Canvas fornece o URL base das Cloud Functions no firebaseConfig
        const cloudFunctionsUrl = firebaseConfig.cloudFunctionsUrl || 'http://localhost:5001/seu-projeto/us-central1/';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth, functions;
        let userId = null;
        let isAuthReady = false;

        const CHAT_ID = 'main_chat'; // ID fixo para o chat principal

        // Estado global da aplica√ß√£o
        const appState = {
            appId,
            chatId: CHAT_ID,
            userId: null,
            isThinking: false,
            unsubscribe: null, // Para listener do Firestore
            conversationHistory: [], // Hist√≥rico de mensagens para a IA
            renderedMessageIds: new Set(), // üõë CORRE√á√ÉO CR√çTICA: Previne dupla renderiza√ß√£o
        };

        // Mapeamento de elementos do DOM
        const elements = {
            chatMessages: document.getElementById('chat-messages'),
            userInput: document.getElementById('user-input'),
            sendButton: document.getElementById('send-button'),
            quickReplies: document.getElementById('quick-replies'),
            userIdDisplay: document.getElementById('user-id-display'),
        };

        // --- Fun√ß√µes Auxiliares ---

        function toggleThinking(state) {
            appState.isThinking = state;
            elements.sendButton.disabled = state;
            elements.userInput.disabled = state;
            elements.userInput.placeholder = state ? 'Centelha est√° pensando...' : 'Digite sua mensagem...';
            elements.sendButton.classList.toggle('opacity-50', state);
        }

        function scrollToBottom() {
            elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
        }

        // üßº AJUSTE DE CLEAN CODE: Sanitiza√ß√£o de Texto
        function sanitizeText(text) {
            // Previne XSS b√°sico substituindo HTML tags
            return text.replace(/</g, "&lt;").replace(/>/g, "&gt;");
        }

        // üßº AJUSTE DE CLEAN CODE: Renderiza um bot√£o de quick reply
        function renderQuickReplies(replies = []) {
            elements.quickReplies.innerHTML = '';
            if (replies.length > 0) {
                replies.forEach(reply => {
                    const button = document.createElement('button');
                    button.textContent = reply;
                    button.className = 'chat-action-button bg-blue-500 hover:bg-blue-600 text-white';
                    button.onclick = () => {
                        elements.userInput.value = reply;
                        sendMessage();
                    };
                    elements.quickReplies.appendChild(button);
                });
            }
        }

        // üßº AJUSTE DE CLEAN CODE: Adiciona mensagem √† UI
        function addMessageToUI(sender, text, messageId) {
            if (appState.renderedMessageIds.has(messageId)) return; // üõë Preven√ß√£o de dupla renderiza√ß√£o

            const messageDiv = document.createElement('div');
            const sanitizedText = sanitizeText(text);

            const isUser = sender === 'user';
            const bubbleClass = isUser ? 'user-bubble' : 'assistant-bubble';
            const justifyClass = isUser ? 'justify-end' : 'justify-start';

            // Regex para links e bot√µes (ajustado para aceitar link e texto do bot√£o)
            const buttonRegex = /\[\[(.+?)\|(.+?)\]\]/g; 

            // üßº AJUSTE DE SEGURAN√áA: Valida√ß√£o de URL
            let htmlText = sanitizedText
                .replace(buttonRegex, (match, buttonText, url) => {
                    const safeUrl = url.trim();
                    // REGRA DE SEGURAN√áA REFOR√áADA: Apenas HTTPS (ou http://googleusercontent.com, se for o caso)
                    if (safeUrl.startsWith('https://') || safeUrl.startsWith('http://googleusercontent.com')) {
                        return `<a href="${safeUrl}" target="_blank" rel="noopener noreferrer" class="chat-action-button bg-gradient-to-br from-yellow-400 to-orange-500 text-white">${buttonText}</a>`;
                    }
                    console.warn('Tentativa de renderizar bot√£o com URL inv√°lida foi bloqueada:', safeUrl);
                    return `[Bot√£o com link inv√°lido]`; // Evita a inje√ß√£o
                })
                .replace(/\n/g, '<br>'); // Converte quebras de linha

            messageDiv.className = `flex ${justifyClass}`;
            messageDiv.innerHTML = `
                <div id="msg-${messageId}" class="message-bubble ${bubbleClass}">
                    ${htmlText}
                </div>
            `;
            elements.chatMessages.appendChild(messageDiv);
            appState.renderedMessageIds.add(messageId);
            scrollToBottom();
        }

        // --- L√≥gica de Banco de Dados (Firestore) ---

        // üõë CORRE√á√ÉO CR√çTICA DE ESTABILIDADE: Otimiza√ß√£o com docChanges (Delta Updates)
        function listenToMessages() {
            if (appState.unsubscribe) appState.unsubscribe(); // Cancela o listener anterior

            // Cole√ß√£o privada do usu√°rio
            const messagesColRef = collection(db, `artifacts/${appState.appId}/users/${appState.userId}/chats/${appState.chatId}/messages`);
            const q = query(messagesColRef, orderBy("createdAt"));

            appState.unsubscribe = onSnapshot(q, (snapshot) => {
                let initialLoad = true;
                if (snapshot.docChanges().length !== snapshot.size) {
                    initialLoad = false;
                }

                // üõë L√≥gica para lidar com a primeira carga ou reset:
                if (initialLoad) {
                    elements.chatMessages.innerHTML = '';
                    appState.renderedMessageIds.clear();
                    appState.conversationHistory = [];
                }

                let lastQuickReplies = [];
                let newMessages = false;
                
                snapshot.docChanges().forEach(change => {
                    if (change.type === "added") {
                        const doc = change.doc;
                        const data = doc.data();
                        const messageId = doc.id;
                        
                        // Ignora se j√° renderizado (preven√ß√£o de dupla renderiza√ß√£o/concorr√™ncia)
                        if (appState.renderedMessageIds.has(messageId)) return;
                        
                        let textForUI = data.text;
                        let textForHistory = data.text; // Salva o texto bruto ou JSON para o hist√≥rico da IA
                        
                        if (data.sender === 'assistant') {
                            try {
                                const parsed = JSON.parse(data.text);
                                textForUI = parsed.responseText || data.text;
                                textForHistory = data.text; // Guarda o JSON para o hist√≥rico
                                lastQuickReplies = parsed.quickReplies || [];
                            } catch (e) { 
                                // üõë FALHA PREVENTIVA: Se o JSON for inv√°lido, salva o erro para an√°lise e exibe o texto bruto
                                console.error("Mensagem do Assistente n√£o √© um JSON v√°lido:", data.text, e);
                                textForUI = `[ERRO DE FORMATO - Contate o suporte] ${data.text}`;
                                lastQuickReplies = [];
                            }
                        }
                        
                        // Adiciona ao hist√≥rico do estado e renderiza
                        appState.conversationHistory.push({
                            role: data.sender === 'user' ? 'user' : 'model',
                            parts: [{ text: textForHistory }]
                        });
                        addMessageToUI(data.sender, textForUI, messageId);
                        newMessages = true;
                    }
                });
                
                // üßº L√≥gica de Continua√ß√£o e Quick Replies
                if (newMessages) {
                     const lastMessage = appState.conversationHistory[appState.conversationHistory.length - 1];
                     // Apenas renderiza Quick Replies se a √∫ltima mensagem for do modelo
                     if (lastMessage && lastMessage.role === 'model') {
                        toggleThinking(false);
                        renderQuickReplies(lastQuickReplies); 
                     }
                }
                
            }, (error) => {
                console.error("Erro ao ouvir mensagens (FATAL):", error);
                addMessageToUI('assistant', 'N√£o foi poss√≠vel carregar o hist√≥rico. Por favor, atualize a p√°gina.', 'error-load');
                toggleThinking(false);
            });
        }

        // --- L√≥gica de Neg√≥cios (Chama a Cloud Function) ---

        async function handleConversation(userMessageText) {
            toggleThinking(true);
            renderQuickReplies([]);
            
            let messageDocRef;

            try {
                // 1. Salva a mensagem do usu√°rio no Firestore (aciona o listener)
                messageDocRef = await addDoc(collection(db, `artifacts/${appState.appId}/users/${appState.userId}/chats/${appState.chatId}/messages`), {
                    sender: 'user',
                    text: userMessageText,
                    createdAt: Date.now(),
                    userId: appState.userId,
                });

                // 2. ‚ö°Ô∏è CORRE√á√ÉO CR√çTICA: Chama a Cloud Function para gerar a resposta da IA
                const authToken = await auth.currentUser.getIdToken();
                const conversationEndpoint = `${cloudFunctionsUrl}centelhaConversation`; // Usa a fun√ß√£o 'centelhaConversation'

                const response = await fetch(conversationEndpoint, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}` // Envia o token de autentica√ß√£o
                    },
                    body: JSON.stringify({
                        conversationHistory: appState.conversationHistory,
                        userId: appState.userId,
                        appId: appState.appId,
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `Erro do Backend: ${response.status}`);
                }
                
                // O Listener do Firestore (listenToMessages) cuidar√° de renderizar a resposta da Centelha.
                
            } catch (error) {
                console.error("Erro ao processar a conversa:", error);
                
                // Remove a mensagem do usu√°rio se a chamada ao backend falhar (opcional, mas limpa)
                if (messageDocRef) {
                    // Nota: O listener do Firestore j√° pode ter disparado, mas a remo√ß√£o aqui limpa o Firestore.
                    // deleteDoc(messageDocRef); 
                }
                
                addMessageToUI('assistant', `Houve um erro no sistema da Centelha. Por favor, tente novamente. Detalhe: ${error.message}`, 'error-send');
                toggleThinking(false);
            }
        }

        // --- Inicializa√ß√£o e Eventos ---

        function sendMessage() {
            const text = elements.userInput.value.trim();
            if (text && !appState.isThinking) {
                handleConversation(text);
                elements.userInput.value = '';
            }
        }

        elements.sendButton.addEventListener('click', sendMessage);
        elements.userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // --- Inicializa√ß√£o Firebase e Autentica√ß√£o ---

        async function initialize() {
            try {
                // üõë CORRE√á√ÉO CR√çTICA: Preven√ß√£o de Falhas Futuras
                if (!firebaseConfig.apiKey) {
                    console.error("Firebase Config Inv√°lida. Verifique __firebase_config.");
                    return;
                }

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                functions = getFunctions(app); // Inicializa Functions

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        appState.userId = user.uid;
                        elements.userIdDisplay.textContent = `ID: ${user.uid.substring(0, 8)}...`;
                        isAuthReady = true;
                        
                        // Inicia o listener de mensagens (s√≥ depois de autenticado)
                        listenToMessages();
                    } else {
                         // üêõ CORRE√á√ÉO DE ERRO DE LOG: Remove a tentativa redundante de sign-in e o console.error.
                         // O estado 'null' √© esperado durante a inicializa√ß√£o antes do sign-in abaixo.
                         console.log("Autentica√ß√£o em andamento...");
                    }
                });

                // Tenta autenticar com o token personalizado ou anonimamente
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (e) {
                console.error("Erro FATAL na inicializa√ß√£o do Firebase:", e);
                addMessageToUI('assistant', 'Erro cr√≠tico ao iniciar o sistema. Verifique o console.', 'init-error');
            }
        }

        initialize();

    </script>
</body>
</html>
